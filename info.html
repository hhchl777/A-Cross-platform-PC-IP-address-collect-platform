<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ä¿¡æ¯æµè§ˆç•Œé¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f8f9fa;
      --card: #ffffff;
      --border: #e0e0e0;
      --text: #202124;
      --subtext: #5f6368;
      --primary: #1a73e8;
      --hover: #e8f0fe;
    }

    * {
      box-sizing: border-box;
      font-family: "Google Sans", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    .layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      height: 100vh;
    }

    /* ä¾§æ  */
    .sidebar {
      background: var(--card);
      border-right: 1px solid var(--border);
      padding: 16px 12px;
    }

    .sidebar h1 {
      font-size: 18px;
      margin: 48px 12px 16px;
      font-weight: 600;
    }

    /* ç”¨æˆ·ä¸‹æ‹‰èœå• */
    .user-menu {
      position: relative;
    }

    .user-menu.top-right {
      position: absolute;
      top: 16px;
      right: 24px;
    }

    .user-trigger {
      position: relative;
      margin: 0 8px 8px;
    }

    .user-trigger {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .user-trigger:hover {
      background: var(--hover);
    }

    .user-dropdown {
      position: absolute;
      top: 44px;
      right: 0;
      width: 120px; /* æ”¶çª„ä¸‹æ‹‰æ¡†å®½åº¦ */
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      display: none;
      z-index: 10;
    }

    .user-item {
      padding: 10px 12px;
      font-size: 14px;
      cursor: pointer;
    }

    .user-item:hover {
      background: var(--hover);
    }

    .user-item.logout {
      color: #c5221f;
    }

    .nav-item {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text);
      font-size: 14px;
      margin-bottom: 4px;
    }

    .nav-item.active,
    .nav-item:hover {
      background: var(--hover);
      color: var(--primary);
    }

    /* ä¸»å†…å®¹ */
    .content {
      padding: 24px;
      overflow: auto;
    }

    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .content-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .search {
      padding: 8px 12px;
      border-radius: 24px;
      border: 1px solid var(--border);
      font-size: 14px;
      width: 240px;
    }

    /* è¡¨æ ¼å¡ç‰‡ */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      padding: 8px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    thead {
      background: #f1f3f4;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      font-weight: 500;
      color: var(--subtext);
    }

    tbody tr:hover {
      background: #f8f9fa;
    }

    .status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      display: inline-block;
    }

    .status.ok {
      background: #e6f4ea;
      color: #137333;
    }

    .status.warn {
      background: #fef7e0;
      color: #b06000;
    }

    .status.err {
      background: #fce8e6;
      color: #c5221f;
    }

    /* éšè— */
    .hidden {
      display: none;
    }

    /* å¼¹çª—æ•´ä½“ */
    .modal {
      position: fixed;
      inset: 0;
      z-index: 1000;
    }

    /* é®ç½©å±‚ */
    .modal-mask {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
    }

    /* å¼¹çª—å¡ç‰‡ */
    .modal-card {
      position: relative;
      width: 360px;
      margin: 120px auto;
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    /* è¾“å…¥æ¡† */
    .modal-card input {
      width: 100%;
      padding: 10px 12px;
      margin-top: 12px;
      border-radius: 8px;
      border: 1px solid #dadce0;
      font-size: 14px;
    }

    /* æŒ‰é’®åŒº */
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
      gap: 12px;
    }

    .btn-text {
      background: none;
      border: none;
      color: #5f6368;
      cursor: pointer;
    }

    .btn-primary {
      background: #1a73e8;
      border: none;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
    }

  </style>
</head>
<body>
  <div class="layout">
    <!-- ä¾§æ  -->
    <aside class="sidebar">
      <h1>æ§åˆ¶å°</h1>
      <div class="nav-item active">ç”¨æˆ·ä¿¡æ¯</div>
      <div class="nav-item">è®¾å¤‡ä¿¡æ¯</div>
    </aside>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="content">
      <div class="content-header">
        <div class="user-menu top-right">
          <div class="user-trigger" id="userTrigger">ğŸ‘¤ å½“å‰ç”¨æˆ·</div>
          <div class="user-dropdown" id="userDropdown">
            <div class="user-item" id="changePwdBtn">ä¿®æ”¹å¯†ç </div>
            <div class="user-item logout" id="logoutBtn">é€€å‡ºç™»å½•</div>
          </div>
        </div>
        <h2 id="title">ç”¨æˆ·ä¿¡æ¯åˆ—è¡¨</h2>
      </div>

      <!-- ä¿®æ”¹å¯†ç å¼¹çª— -->
      <div id="passwordModal" class="modal hidden">
        <div class="modal-mask"></div>

        <div class="modal-card">
          <h3>ä¿®æ”¹å¯†ç </h3>

          <input id="oldPwd" type="password" placeholder="åŸå¯†ç " />
          <input id="newPwd" type="password" placeholder="æ–°å¯†ç " />
          <input id="confirmPwd" type="password" placeholder="ç¡®è®¤æ–°å¯†ç " />
          <div id="chpass-msg" class="hint"></div>

          <div class="modal-actions">
            <button id="cancelPwd" class="btn-text">å–æ¶ˆ</button>
            <button id="submitPwd" class="btn-primary">ç¡®è®¤ä¿®æ”¹</button>
          </div>
        </div>
      </div>

      <div class="card">
        <!-- ç”¨æˆ·è¡¨ -->
        <table id="userTable">
          <thead>
            <tr>
              <th>ç”¨æˆ·ID</th>
              <th>é‚®ç®±</th>
              <th>æœ€è¿‘ç™»å½•</th>
            </tr>
          </thead>
          <tbody id="userTableBody">
            <!--è‡ªåŠ¨å¡«å……-->
          </tbody>
        </table>

        <!-- è®¾å¤‡è¡¨ -->
        <table id="deviceTable" style="display:none;">
          <thead>
            <tr>
              <th>è®¾å¤‡ID</th>
              <th>è®¾å¤‡åç§°</th>
              <th>IP</th>
              <th>ç”¨æˆ·ID</th>
              <th>æœ€è¿‘åŒæ­¥</th>
            </tr>
          </thead>
          <tbody id="deviceTableBody">
            <!--è‡ªåŠ¨å¡«å……-->
          </tbody>
        </table>
      </div>
    </main>
  </div>
  <script>
    const navItems = document.querySelectorAll('.nav-item');
    const userTable = document.getElementById('userTable');
    const deviceTable = document.getElementById('deviceTable');
    const title = document.getElementById('title');

    // é€€å‡ºç™»å½•
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      const res = await fetch('/api/logout', {
        method: 'POST',
        credentials: 'include'
      });

      if (res.ok) {
        window.location.href = '/';
      }
    });

    async function chpass() {
      const oldPwd = document.getElementById('oldPwd').value;
      const newPwd = document.getElementById('newPwd').value;
      const confirmPwd = document.getElementById('confirmPwd').value;

      if (newPwd !== confirmPwd) {
        document.getElementById('chpass-msg').innerText = 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´'
        return;
      }

      const res = await fetch('/api/chpass', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',   // â­ å¾ˆé‡è¦ï¼šè®©æµè§ˆå™¨å¸¦ä¸Š cookie
        body: JSON.stringify({
          oldPwd,
          newPwd
        })
      })
      const data = await res.json()

      if (!data.success) {
        if(data.code === 1) {
          document.getElementById('chpass-msg').innerText = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
        } else {
          document.getElementById('chpass-msg').innerText = 'å½“å‰IPè¢«é”å®šï¼Œ5åˆ†é’Ÿåå†è¯•';
        }
      } else {
        const res = await fetch('/api/logout', {
          method: 'POST',
          credentials: 'include'
        });

        if (res.ok) {
          window.location.href = '/';
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const pwdModal = document.getElementById('passwordModal');

      document.getElementById('changePwdBtn').onclick = () => {
        pwdModal.classList.remove('hidden');
      };

      document.getElementById('cancelPwd').onclick = () => {
        pwdModal.classList.add('hidden');
      };

      document.getElementById('submitPwd').onclick = () => {
        chpass();
      };
    });

    async function loadDevices() {
      try {
        const res = await fetch('/api/devices', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          },
          //credentials: 'include' // å¦‚æœä½¿ç”¨ cookie/session
        });

        if (!res.ok) {
          throw new Error('æœåŠ¡å™¨å“åº”å¤±è´¥');
        }

        const data = await res.json();

        const tbody = document.getElementById('deviceTableBody');
        tbody.innerHTML = '';

        data.forEach(data => {
          const tr = document.createElement('tr');

          tr.innerHTML = `
          <td>${data.id}</td>
          <td>${data.name}</td>
          <td>${data.ip}</td>
          <td>${data.owner_id}</td>
          <td>${data.update_time}</td>
        `;

          tbody.appendChild(tr);
        })

      } catch (err) {
        console.error(err);
        alert('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥');
      }
    }

    async function loadusers() {
      try {
        const res = await fetch('/api/users', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          },
          //credentials: 'include' // å¦‚æœä½¿ç”¨ cookie/session
        });

        if (!res.ok) {
          throw new Error('æœåŠ¡å™¨å“åº”å¤±è´¥');
        }

        const data = await res.json();
        // æœŸæœ› data æ ¼å¼ï¼š
        // [{ id, name, status, lastSeen }]
        console.log(data);

        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '';

        data.forEach(data => {
          const tr = document.createElement('tr');

          tr.innerHTML = `
          <td>${data.id}</td>
          <td>${data.email}</td>
          <td>${data.update_time}</td>
        `;
          tbody.appendChild(tr);
        })
      } catch (err) {
        console.error(err);
        alert('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥');
      }
    }

    loadusers();
    navItems.forEach((item, index) => {
      item.addEventListener('click', () => {
        navItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        if (index === 0) {
          title.textContent = 'ç”¨æˆ·ä¿¡æ¯åˆ—è¡¨';
          loadusers();
          userTable.style.display = '';
          deviceTable.style.display = 'none';
        } else {
          title.textContent = 'è®¾å¤‡ä¿¡æ¯åˆ—è¡¨';
          loadDevices();
          userTable.style.display = 'none';
          deviceTable.style.display = '';
        }
      });
    });
      // ç”¨æˆ·ä¸‹æ‹‰èœå•é€»è¾‘
    const trigger = document.getElementById('userTrigger');
    const dropdown = document.getElementById('userDropdown');

    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    });

    document.addEventListener('click', () => {
      dropdown.style.display = 'none';
    });
  </script>
</body>
</html>
